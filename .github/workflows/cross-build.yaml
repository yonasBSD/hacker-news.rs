name: Cross Build

on:
  pull_request:
  push:
    branches: [main]
  workflow_dispatch:
  workflow_run:
    workflows: ["Test with Code Coverage"]
    branches: [main]
    types: [completed]

# Prevent multiple concurrent runs
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  TASKFILE_VERSION: "3.x"

jobs:
  test:
    name: ${{ matrix.os.name }}
    if: >-
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'pull_request' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')

    strategy:
      fail-fast: false
      matrix:
        os:
          # Native Runners
          - { name: Ubuntu, runner: ubuntu-latest, type: native }
          - { name: MacOS, runner: macos-latest, type: native }
          - { name: Windows, runner: windows-latest, type: native }

          # BSD VMs
          - { name: FreeBSD, runner: ubuntu-latest, type: vm }
          - { name: OpenBSD, runner: ubuntu-latest, type: vm }

          # Linux Containers
          - {
              name: Fedora,
              runner: ubuntu-latest,
              type: container,
              image: "fedora:latest",
              install: "dnf install -y rust cargo"
            }
          - {
              name: Rocky,
              runner: ubuntu-latest,
              type: container,
              image: "rockylinux:9",
              install: "dnf install -y rust cargo"
            }
          - {
              name: OpenSUSE,
              runner: ubuntu-latest,
              type: container,
              image: "opensuse/tumbleweed",
              install: "zypper install -y rust cargo"
            }

          # Specialized Linux
          - { name: Alpine, runner: ubuntu-latest, type: alpine }
          - { name: Arch, runner: ubuntu-latest, type: arch }

    runs-on: ${{ matrix.os.runner }}

    # Only activate container for container-type jobs
    container: ${{ matrix.os.type == 'container' && matrix.os.image || null }}

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2
        with:
          egress-policy: block
          allowed-endpoints: >
            api.deps.dev:443
            api.github.com:443
            api.osv.dev:443
            api.scorecard.dev:443
            github.com:443
            objects.githubusercontent.com:443
            release-assets.githubusercontent.com:443
            raw.githubusercontent.com:443
            static.rust-lang.org:443
            static.crates.io:443
            index.crates.io:443
            *.ubuntu.com:80
            *.ubuntu.com:443
            *.packages.microsoft.com:443
            *.freebsd.org:443
            *.openbsd.org:443
            *.netbsd.org:443
            *.alpinelinux.org:443
            dl-cdn.alpinelinux.org:443
            *.archlinux.org:443
            *.pkgbuild.com:443
            *.fedoraproject.org:443
            *.opensuse.org:443
            *.rockylinux.org:443
            *.pool.ntp.org:443
            time.cloudflare.com:443
            taskfile.dev:443

      - name: Checkout sources
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      # ===========================================
      # Native OS (Ubuntu, macOS, Windows)
      # ===========================================
      - name: Install Rust
        if: matrix.os.type == 'native'
        uses: dtolnay/rust-toolchain@e97e2d8cc328f1b50210efc529dca0028893a2d9 # v1
        with:
          toolchain: nightly

      - name: Setup Rust cache
        if: matrix.os.type == 'native'
        uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2

      - name: Install Taskfile
        if: matrix.os.type == 'native'
        uses: arduino/setup-task@b91d5d2c96a56797b48ac1e0e89220bf64044611 # v2.0.0
        with:
          version: ${{ env.TASKFILE_VERSION }}
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Run tests
        if: matrix.os.type == 'native'
        run: task test

      # ===========================================
      # Container-based Linux (Fedora, Rocky, etc.)
      # ===========================================
      - name: Install dependencies
        if: matrix.os.type == 'container'
        run: |
          ${{ matrix.os.install }}
          sh -c "$(curl --location https://taskfile.dev/install.sh)" -- -d -b /usr/local/bin

      - name: Run tests
        if: matrix.os.type == 'container'
        run: task test

      # ===========================================
      # VM-based (BSD)
      # ===========================================
      - name: Run tests in FreeBSD VM
        if: matrix.os.name == 'FreeBSD'
        uses: vmactions/freebsd-vm@v1
        with:
          usesh: true
          sync: rsync
          prepare: |
            pkg update -f && pkg install -y curl rust-nightly task
          run: task test

      - name: Run tests in OpenBSD VM
        if: matrix.os.name == 'OpenBSD'
        uses: vmactions/openbsd-vm@v1
        with:
          usesh: true
          sync: rsync
          prepare: |
            pkg_add curl rust go
            env GOBIN=/usr/local/bin go install github.com/go-task/task/v3/cmd/task@latest
          run: task test

      # ===========================================
      # Alpine Linux
      # ===========================================
      - name: Setup Alpine Linux
        if: matrix.os.type == 'alpine'
        uses: jirutka/setup-alpine@ae3b3ddba35054804fc4a3507b519fa7e8152050 # v1
        with:
          branch: edge

      - name: Run tests
        if: matrix.os.type == 'alpine'
        run: |
          apk add go-task
          task test
        shell: alpine.sh --root {0}

      # ===========================================
      # Arch Linux
      # ===========================================
      - name: Setup Arch Linux
        if: matrix.os.type == 'arch'
        uses: RangHo/setup-arch@19885eda0c0b0d1791e61e1d32f2552d42944b14 # main
        with:
          packages: "rust go-task"

      - name: Run tests
        if: matrix.os.type == 'arch'
        run: task test
